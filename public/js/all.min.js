var Box,Grid,Server,active,canvasOffset,canvas_xlimits,distrib,grid,heartbeats,line,rhclusters,server,serverJson,servers,web_app,x,y,_i,_j,_len,_len2;window.Grid=Grid=function(){function a(a){a==null&&(a={}),this.options=a}a.prototype.distribute_horizontally=function(a,b,c,d){var e,f,g,h,i;e=function(){var b;b=[];for(i=1;1<=a?i<=a:i>=a;1<=a?i++:i--)b.push(i);return b}(),e=e.map(function(a){return a*b}),f=(d+c)/2,h=b*(a-1)/2,g=f-h,e=e.map(function(a){return g-b+a});return e};return a}(),window.Box=Box=function(){function a(a){this.coords=a}a.prototype.center=function(){return this.barycenter(this.coords[0],this.coords[2])},a.prototype.barycenter=function(a,b){var c,d;c=(a[0]+b[0])/2,d=(a[1]+b[1])/2;return[c,d]};return a}(),window.Server=Server=function(){function a(a,b){var c,d;b==null&&(b={}),this.name=a;for(c in b)d=b[c],this[c]=d}a.prototype.toHtml=function(){var a,b;a='<div class="draggable server '+this.css_class+'" id="srv_'+this.name+'" ',this.targets()&&this.targets().length>0&&(b=this.targets().map(function(a){return"srv_"+a}).join(","),a+='rel="'+b+'" '),a+='style="left:'+this.pos_x+"px; top:"+this.pos_y+'px">',a+="<h5>"+this.name+'<span class="port">:'+this.port+"</span></h5>",this.desc&&(a+="<div>"+this.desc+"</div>"),a+="</div>";return a},a.prototype.targets=function(){return this.link_to&&this.link_to.length>1?this.link_to.split(",").map(function(a){return a.trim()}):[]};return a}(),Raphael.fn.connection=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;a.line&&a.from&&a.to&&(c=a,a=c.from,b=c.to),h=a.getBBox(),i=b.getBBox(),q=[{x:h.x+h.width/2,y:h.y-1},{x:h.x+h.width/2,y:h.y+h.height+1},{x:h.x-1,y:h.y+h.height/2},{x:h.x+h.width+1,y:h.y+h.height/2},{x:i.x+i.width/2,y:i.y-1},{x:i.x+i.width/2,y:i.y+i.height+1},{x:i.x-1,y:i.y+i.height/2},{x:i.x+i.width+1,y:i.y+i.height/2}],q=[q[0],q[1],q[0],q[1],q[4],q[5],q[4],q[5]],k={},l=[];for(o=0;o<=3;o++)for(p=4;p<=7;p++){m=Math.abs(q[o].x-q[p].x),n=Math.abs(q[o].y-q[p].y);if(o===p-4||(o!==3&&p!==6||q[o].x<q[p].x)&&(o!==2&&p!==7||q[o].x>q[p].x)&&(o!==0&&p!==5||q[o].y>q[p].y)&&(o!==1&&p!==4||q[o].y<q[p].y))l.push(m+n),k[l[l.length-1]]=[o,p]}l.length===0?s=[0,4]:s=k[Math.min.apply(Math,l)],t=q[s[0]].x,x=q[s[0]].y,w=q[s[1]].x,A=q[s[1]].y,m=Math.max(Math.abs(t-w)/2,10),n=Math.max(Math.abs(x-A)/2,10),u=[t,t,t-m,t+m][s[0]].toFixed(3),y=[x-n,x+n,x,x][s[0]].toFixed(3),v=[0,0,0,0,w,w,w-m,w+m][s[1]].toFixed(3),z=[0,0,0,0,x+n,x-n,A,A][s[1]].toFixed(3),f=9,g=4,d=Math.atan2(t-w,A-x),d=d/(2*Math.PI)*360,e=["M",w,A,"L",w-f,A-g,"L",w-f,A+g,"L",w,A].join(","),r=["M",t,x,w,A].join(","),j="#444";if(c&&c.line){c.line.attr({path:r}),c.arrow.remove();return c.arrow=this.path(e).attr({stroke:j,fill:j}).rotate(90+d,w,A)}return{line:this.path(r).attr({stroke:j,fill:"none"}),arrow:this.path(e).attr({stroke:j,fill:j}).rotate(90+d,w,A),from:a,to:b}},web_app=[[{name:"lb-intra-01",port:80,css_class:"server-lb",link_to:"apache-01, apache-02"},{name:"lb-intra-02",port:80,css_class:"server-lb server-passive"}],[{name:"apache-01",port:80,desc:"Apache 2.2.3",css_class:"server-rp",link_to:"lb-j2ee-01"},{name:"apache-02",port:80,desc:"Apache 2.2.3",css_class:"server-rp",link_to:"lb-j2ee-01"}],[{name:"lb-j2ee-01",port:80,css_class:"server-lb",link_to:"tomcat-01, tomcat-02, tomcat-03"},{name:"lb-j2ee-02",port:80,css_class:"server-lb server-passive"}],[{name:"tomcat-01",port:80,desc:"Tomcat 6.0.18 - JDK 1.6.0<br>256m &rarr; 1024m",css_class:"server-j2ee",link_to:"postgres-01"},{name:"tomcat-02",port:80,desc:"Tomcat 6.0.18 - JDK 1.6.0<br>256m &rarr; 1024m",css_class:"server-j2ee",link_to:"postgres-01"},{name:"tomcat-03",port:80,desc:"Tomcat 6.0.18 - JDK 1.6.0<br>128m &rarr; 512m",css_class:"server-j2ee",link_to:"postgres-01"}],[{name:"postgres-01",port:5432,desc:"Postgresql 9.0<br>user-01@app-01(5G)",css_class:"server-postgres"},{name:"postgres-02",port:5432,desc:"Postgresql 9.0<br>user-01@app-01(5G)",css_class:"server-postgres server-passive"}]],rhclusters=[["postgres-01","postgres-02"]],heartbeats=[["lb-intra-01","lb-intra-02"],["lb-j2ee-01","lb-j2ee-02"]],servers=[],grid=new Grid({x_start:100,x_step:170,y_start:30,y_step:110}),canvas_xlimits=[0,400],canvasOffset=7.5,y=grid.options.y_start;for(_i=0,_len=web_app.length;_i<_len;_i++){line=web_app[_i],active=$.grep(line,function(a){return!a.css_class.match(/passive/)}),distrib=grid.distribute_horizontally(active.length,grid.options.x_step,canvas_xlimits[0],canvas_xlimits[1]),x=distrib[0];for(_j=0,_len2=line.length;_j<_len2;_j++)serverJson=line[_j],server=new Server(serverJson.name,serverJson),server.pos_x=x,server.pos_y=y,x+=grid.options.x_step,servers.push(server);y+=grid.options.y_step,line[0].css_class.match(/server-lb/)&&(y-=50)}$(function(){return $(".draggable").live("mouseenter",function(){return $(this).addClass("hover")}).live("mouseleave",function(){return $(this).removeClass("hover")}).live("click",function(){return $(this).toggleClass("selected")})}),$(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;e=Raphael("map",550,450),i=[],f={},$.each(servers,function(){var a,b,c,d,h,j;$(this.toHtml()).insertBefore($("#map")),g=$("#srv_"+this.name)[0],j=[this.pos_x-canvasOffset,this.pos_y-canvasOffset,$(g).outerWidth()+1,$(g).outerHeight()+1],x=j[0],y=j[1],h=j[2],b=j[3],a=document.createElementNS(e.svgns,"foreignObject"),a.setAttribute("x",x),a.setAttribute("y",y),a.setAttribute("width",h),a.setAttribute("height",b),c=document.createElementNS("http://www.w3.org/1999/xhtml","div"),g.setAttribute("style",""),c.appendChild(g),a.appendChild(c),e.canvas.appendChild(a),d=e.rect(x,y,h,b),d.foreign=a,i.push(d);return f[this.name]=d}),c=function(){this.ox=this.attr("x"),this.oy=this.attr("y");if(this.foreign){this.foreign.ox=this.foreign.getAttribute("x");return this.foreign.oy=this.foreign.getAttribute("y")}},d=function(a,c){var d,f,g;this.attr({x:this.ox+a,y:this.oy+c}),this.foreign&&(this.foreign.setAttribute("x",parseFloat(this.foreign.ox)+a),this.foreign.setAttribute("y",parseFloat(this.foreign.oy)+c));for(f=0,g=b.length;f<g;f++)d=b[f],e.connection(d);return e.safari()},k=function(){};for(l=0,n=i.length;l<n;l++)h=i[l],a=Raphael.getColor(),h.attr({fill:a,stroke:a,"fill-opacity":0,"stroke-opacity":0,"stroke-width":0,cursor:"move"}),h.drag(d,c,k);b=[],p=[];for(m=0,o=servers.length;m<o;m++)g=servers[m],p.push(function(){var a,c,d,h;d=g.targets(),h=[];for(c=0,a=d.length;c<a;c++)j=d[c],h.push(f[j]?b.push(e.connection(f[g.name],f[j])):void 0);return h}());return p})