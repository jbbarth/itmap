var Box,Grid,Server,active,canvasOffset,canvas_xlimits,distrib,grid,heartbeats,line,rhclusters,server,serverJson,servers,web_app,x,y,_i,_j,_len,_len2;window.Grid=Grid=function(){function a(a){a==null&&(a={}),this.options=a}a.prototype.distribute_horizontally=function(a,b,c,d){var e,f,g,h,i;e=function(){var b;b=[];for(i=1;1<=a?i<=a:i>=a;1<=a?i++:i--)b.push(i);return b}(),e=e.map(function(a){return a*b}),f=(d+c)/2,h=b*(a-1)/2,g=f-h,e=e.map(function(a){return g-b+a});return e};return a}(),window.Box=Box=function(){function a(a){this.coords=a}a.prototype.center=function(){return this.barycenter(this.coords[0],this.coords[2])},a.prototype.barycenter=function(a,b){var c,d;c=(a[0]+b[0])/2,d=(a[1]+b[1])/2;return[c,d]};return a}(),window.Server=Server=function(){function a(a,b){var c,d;b==null&&(b={}),this.name=a;for(c in b)d=b[c],this[c]=d}a.prototype.toHtml=function(){var a,b;a='<div class="draggable server '+this.css_class+'" id="srv_'+this.name+'" ',this.targets()&&this.targets().length>0&&(b=this.targets().map(function(a){return"srv_"+a}).join(","),a+='rel="'+b+'" '),a+='style="left:'+this.pos_x+"px; top:"+this.pos_y+'px">',a+="<h5>"+this.name+'<span class="port">:'+this.port+"</span></h5>",this.desc&&(a+="<div>"+this.desc+"</div>"),a+="</div>";return a},a.prototype.targets=function(){return this.link_to&&this.link_to.length>1?this.link_to.split(",").map(function(a){return a.trim()}):[]};return a}(),Raphael.fn.connection=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;a.line&&a.from&&a.to&&(c=a,a=c.from,b=c.to),d=a.getBBox(),e=b.getBBox(),m=[{x:d.x+d.width/2,y:d.y-1},{x:d.x+d.width/2,y:d.y+d.height+1},{x:d.x-1,y:d.y+d.height/2},{x:d.x+d.width+1,y:d.y+d.height/2},{x:e.x+e.width/2,y:e.y-1},{x:e.x+e.width/2,y:e.y+e.height+1},{x:e.x-1,y:e.y+e.height/2},{x:e.x+e.width+1,y:e.y+e.height/2}],m=[m[0],m[1],m[0],m[1],m[4],m[5],m[4],m[5]],g={},h=[];for(k=0;k<=3;k++)for(l=4;l<=7;l++){i=Math.abs(m[k].x-m[l].x),j=Math.abs(m[k].y-m[l].y);if(k===l-4||(k!==3&&l!==6||m[k].x<m[l].x)&&(k!==2&&l!==7||m[k].x>m[l].x)&&(k!==0&&l!==5||m[k].y>m[l].y)&&(k!==1&&l!==4||m[k].y<m[l].y))h.push(i+j),g[h[h.length-1]]=[k,l]}h.length===0?o=[0,4]:o=g[Math.min.apply(Math,h)],p=m[o[0]].x,t=m[o[0]].y,s=m[o[1]].x,w=m[o[1]].y,i=Math.max(Math.abs(p-s)/2,10),j=Math.max(Math.abs(t-w)/2,10),q=[p,p,p-i,p+i][o[0]].toFixed(3),u=[t-j,t+j,t,t][o[0]].toFixed(3),r=[0,0,0,0,s,s,s-i,s+i][o[1]].toFixed(3),v=[0,0,0,0,t+j,t-j,w,w][o[1]].toFixed(3),n=["M",p.toFixed(3),t.toFixed(3),s.toFixed(3),w.toFixed(3)].join(",");if(c&&c.line)return c.line.attr({path:n});f=typeof c=="string"?c:"#000";return{line:this.path(n).attr({stroke:f,fill:"none"}),from:a,to:b}},web_app=[[{name:"lb-intra-01",port:80,css_class:"server-lb",link_to:"apache-01, apache-02"},{name:"lb-intra-02",port:80,css_class:"server-lb server-passive"}],[{name:"apache-01",port:80,desc:"Apache 2.2.3",css_class:"server-rp",link_to:"lb-j2ee-01"},{name:"apache-02",port:80,desc:"Apache 2.2.3",css_class:"server-rp",link_to:"lb-j2ee-01"}],[{name:"lb-j2ee-01",port:80,css_class:"server-lb",link_to:"tomcat-01, tomcat-02, tomcat-03"},{name:"lb-j2ee-02",port:80,css_class:"server-lb server-passive"}],[{name:"tomcat-01",port:80,desc:"Tomcat 6.0.18 - JDK 1.6.0<br>256m &rarr; 1024m",css_class:"server-j2ee",link_to:"postgres-01"},{name:"tomcat-02",port:80,desc:"Tomcat 6.0.18 - JDK 1.6.0<br>256m &rarr; 1024m",css_class:"server-j2ee",link_to:"postgres-01"},{name:"tomcat-03",port:80,desc:"Tomcat 6.0.18 - JDK 1.6.0<br>128m &rarr; 512m",css_class:"server-j2ee",link_to:"postgres-01"}],[{name:"postgres-01",port:5432,desc:"Postgresql 9.0<br>user-01@app-01(5G)",css_class:"server-postgres"},{name:"postgres-02",port:5432,desc:"Postgresql 9.0<br>user-01@app-01(5G)",css_class:"server-postgres server-passive"}]],rhclusters=[["postgres-01","postgres-02"]],heartbeats=[["lb-intra-01","lb-intra-02"],["lb-j2ee-01","lb-j2ee-02"]],servers=[],grid=new Grid({x_start:100,x_step:170,y_start:30,y_step:110}),canvas_xlimits=[0,400],canvasOffset=7.5,y=grid.options.y_start;for(_i=0,_len=web_app.length;_i<_len;_i++){line=web_app[_i],active=$.grep(line,function(a){return!a.css_class.match(/passive/)}),distrib=grid.distribute_horizontally(active.length,grid.options.x_step,canvas_xlimits[0],canvas_xlimits[1]),x=distrib[0];for(_j=0,_len2=line.length;_j<_len2;_j++)serverJson=line[_j],server=new Server(serverJson.name,serverJson),server.pos_x=x,server.pos_y=y,x+=grid.options.x_step,servers.push(server);y+=grid.options.y_step,line[0].css_class.match(/server-lb/)&&(y-=50)}$(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;f=Raphael("map",550,450),a={width:153,minheight:20,maxheight:46},j=[],g={},$.each(servers,function(){var b,c,d,e,i,k,l;$(this.toHtml()).insertBefore($("#map")),h=$("#srv_"+this.name)[0],d=$(h).outerHeight()+1,l=[this.pos_x-canvasOffset,this.pos_y-canvasOffset,a.width+50,d],x=l[0],y=l[1],k=l[2],c=l[3],b=document.createElementNS(f.svgns,"foreignObject"),b.setAttribute("x",x),b.setAttribute("y",y),b.setAttribute("width",k),b.setAttribute("height",c),e=document.createElementNS("http://www.w3.org/1999/xhtml","div"),h.setAttribute("style",""),e.appendChild(h),b.appendChild(e),f.canvas.appendChild(b),i=f.rect(x,y,k,c),i.toFront(),i.foreign=b,j.push(i);return g[this.name]=i}),d=function(){this.ox=this.attr("x"),this.oy=this.attr("y");if(this.foreign){this.foreign.ox=this.foreign.getAttribute("x");return this.foreign.oy=this.foreign.getAttribute("y")}},e=function(a,b){var d,e,g;this.attr({x:this.ox+a,y:this.oy+b}),this.foreign&&(this.foreign.setAttribute("x",parseFloat(this.foreign.ox)+a),this.foreign.setAttribute("y",parseFloat(this.foreign.oy)+b));for(e=0,g=c.length;e<g;e++)d=c[e],f.connection(d);return f.safari()},l=function(){};for(m=0,o=j.length;m<o;m++)i=j[m],b=Raphael.getColor(),i.attr({fill:b,stroke:b,"fill-opacity":0,"stroke-opacity":0,"stroke-width":0,cursor:"move"}),i.drag(e,d,l);c=[],q=[];for(n=0,p=servers.length;n<p;n++)h=servers[n],q.push(function(){var a,b,d,e;d=h.targets(),e=[];for(b=0,a=d.length;b<a;b++)k=d[b],e.push(g[k]?c.push(f.connection(g[h.name],g[k],"#444")):void 0);return e}());return q})